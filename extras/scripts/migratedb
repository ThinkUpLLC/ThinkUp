#!/bin/bash

cd `dirname $0`/../..
source ./extras/scripts/migratedb-conf
cd webapp/install/sql/mysql_migrations/

echo "DROP DATABASE $db_name;" | $mysql -u $db_user -p$db_password
echo "CREATE DATABASE $db_name COLLATE utf8_bin;" | $mysql -u $db_user -p$db_password

for f in *.sql.migration
do
  echo "mysql -u $db_user -p$db_password $db_name < $f"
  cat $f | sed 's/#rollback=[0-9]*//' | $mysql -u $db_user -p$db_password $db_name
done

for f in *.sql
do
  echo "mysql -u $db_user -p$db_password $db_name < $f"
  cat $f | sed 's/#rollback=[0-9]*//' | $mysql -u $db_user -p$db_password $db_name
done

now=`date '+%Y-%m-%d'`
echo "-- 
-- ThinkUp Database Creation Script
-- Auto-generated by thinkup/extras/scripts/migratedb script on $now
--

ALTER DATABASE DEFAULT CHARACTER SET utf8 COLLATE utf8_general_ci;
" >  build-db_mysql-upcoming-release.sql
$mysqldump --create-options --skip-set-charset --skip-add-drop-table --no-data --skip-add-locks --skip-disable-keys -u $db_user -p$db_password $db_name |egrep -v "(^SET|^/\*\!)" | sed 's/AUTO_INCREMENT=[0-9]*//' | sed "s/\`//g" |  tail -n+7 >>  build-db_mysql-upcoming-release.sql


## set up app db version option
DB_VERSION=`php ../../../../extras/scripts/getversion.php`;

echo "
--
-- Insert DB Version
--
INSERT INTO tu_options (namespace, option_name, option_value, last_updated, created)
VALUES ('application_options', 'database_version', '${DB_VERSION}', NOW(), NOW()); " >> build-db_mysql-upcoming-release.sql

echo "
--
-- Insert default plugin(s)
--

INSERT INTO tu_plugins (name , folder_name, description, author, homepage, version, is_active )
VALUES ('Twitter', 'twitter', 'Twitter support', 'Gina Trapani', 'http://thinkup.com', '0.01', '1');

INSERT INTO tu_plugins (name , folder_name, description, author, homepage, version, is_active )
VALUES ('Facebook', 'facebook', 'Facebook support', 'Gina Trapani', 'http://thinkup.com', '0.01', '1');

INSERT INTO tu_plugins (name , folder_name, description, author, homepage, version, is_active )
VALUES ('Foursquare', 'foursquare', 'Foursquare support', 'Aaron Kalair', 'http://thinkup.com', '0.01', '1');

INSERT INTO tu_plugins (name , folder_name, description, author, homepage, version, is_active )
VALUES ('Google+', 'googleplus', 'Google+ support', 'Gina Trapani', 'http://thinkup.com', '0.01', '1');

INSERT INTO tu_plugins (name , folder_name, description, author, homepage, version, is_active )
VALUES ('Expand URLs', 'expandurls', 'Expand shortened links.', 'Gina Trapani', 'http://thinkup.com', '0.01', '1');

INSERT INTO tu_plugins (name , folder_name, description, author, homepage, version, is_active )
VALUES ('Insights Generator', 'insightsgenerator', 'Pluggable plugin populates the insights stream.', 'Gina Trapani', 'http://thinkup.com', '0.01', '1');" >>  build-db_mysql-upcoming-release.sql


mv  build-db_mysql-upcoming-release.sql ../.

cd ..

echo "

Check the output for errors.
Complete build script generated and saved as $(pwd)/build-db_mysql-upcoming-release.sql"
